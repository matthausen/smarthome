package service

import (
	"net/http"
	"net/http/httptest"
	"testing"
)

func TestHealthCheckHandler(t *testing.T) {
	req, err := http.NewRequest("GET", "/health", nil)
	if err != nil {
		t.Fatal(err)
	}

	rr := httptest.NewRecorder()
	handler := http.HandlerFunc(HealthCheck)

	handler.ServeHTTP(rr, req)

	if status := rr.Code; status != http.StatusOK {
		t.Errorf("handler returned wrong status code: got %v want %v",
			status, http.StatusOK)
	}

	expected := `{"alive":true}`
	if rr.Body.String() != expected {
		t.Errorf("handler returned unexpected body: got %v want %v",
			rr.Body.String(), expected)
	}
}

func CurrentWeatherHandlerTest(t *testing.T) {
	req, err := http.NewRequest("GET", "/api/v1/weather/current", nil)
	if err != nil {
		t.Fatal(err)
	}

	rr := httptest.NewRecorder()
	handler := http.HandlerFunc(CurrentWeatherHandler)

	handler.ServeHTTP(rr, req)

	if status := rr.Code; status != http.StatusOK {
		t.Errorf("handler returned wrong status code: got %v want %v",
			status, http.StatusOK)
	}

	expected := `{"coord":{"lon":-0.1257,"lat":51.5085},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"base":"stations","main":{"temp":290.37,"feels_like":290.11,"temp_min":286.47,"temp_max":292.13,"pressure":1024,"humidity":75},"visibility":10000,"wind":{"speed":1.77,"deg":232,"gust":4.2},"clouds":{"all":100},"dt":1623100284,"sys":{"type":2,"id":2019646,"country":"GB","sunrise":1623037511,"sunset":1623096831},"timezone":3600,"id":2643743,"name":"London","cod":200}`
	if rr.Body.String() != expected {
		t.Errorf("handler returned unexpected body: got %v want %v",
			rr.Body.String(), expected)
	}
}

func FiveDaysForecastHandlerTest(t *testing.T) {
	req, err := http.NewRequest("GET", "/api/v1/weather/forecast", nil)
	if err != nil {
		t.Fatal(err)
	}

	rr := httptest.NewRecorder()
	handler := http.HandlerFunc(FiveDaysForecastHandler)

	handler.ServeHTTP(rr, req)

	if status := rr.Code; status != http.StatusOK {
		t.Errorf("handler returned wrong status code: got %v want %v",
			status, http.StatusOK)
	}

	expected := `{"cod":"200","message":0,"cnt":40,"list":[{"dt":1623110400,"main":{"temp":289.46,"feels_like":289.29,"temp_min":287.7,"temp_max":289.46,"pressure":1024,"sea_level":1024,"grnd_level":1021,"humidity":82,"temp_kf":1.76},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"clouds":{"all":93},"wind":{"speed":1.53,"deg":248,"gust":3.16},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2021-06-08 00:00:00"},{"dt":1623121200,"main":{"temp":287.61,"feels_like":287.44,"temp_min":286.25,"temp_max":287.61,"pressure":1024,"sea_level":1024,"grnd_level":1020,"humidity":89,"temp_kf":1.36},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03n"}],"clouds":{"all":50},"wind":{"speed":1.4,"deg":257,"gust":2.06},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2021-06-08 03:00:00"},{"dt":1623132000,"main":{"temp":287.47,"feels_like":287.07,"temp_min":287.47,"temp_max":287.47,"pressure":1024,"sea_level":1024,"grnd_level":1021,"humidity":81,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02d"}],"clouds":{"all":23},"wind":{"speed":1.29,"deg":276,"gust":1.61},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-08 06:00:00"},{"dt":1623142800,"main":{"temp":291.8,"feels_like":291.29,"temp_min":291.8,"temp_max":291.8,"pressure":1024,"sea_level":1024,"grnd_level":1021,"humidity":60,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":46},"wind":{"speed":1.83,"deg":252,"gust":2.17},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-08 09:00:00"},{"dt":1623153600,"main":{"temp":294.65,"feels_like":293.95,"temp_min":294.65,"temp_max":294.65,"pressure":1023,"sea_level":1023,"grnd_level":1020,"humidity":42,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":58},"wind":{"speed":2.57,"deg":257,"gust":2.72},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-08 12:00:00"},{"dt":1623164400,"main":{"temp":295.62,"feels_like":294.94,"temp_min":295.62,"temp_max":295.62,"pressure":1022,"sea_level":1022,"grnd_level":1019,"humidity":39,"temp_kf":0},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04d"}],"clouds":{"all":99},"wind":{"speed":2.6,"deg":281,"gust":2.64},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-08 15:00:00"},{"dt":1623175200,"main":{"temp":294.36,"feels_like":293.76,"temp_min":294.36,"temp_max":294.36,"pressure":1022,"sea_level":1022,"grnd_level":1019,"humidity":47,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":73},"wind":{"speed":2.74,"deg":288,"gust":2.41},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-08 18:00:00"},{"dt":1623186000,"main":{"temp":290.08,"feels_like":289.71,"temp_min":290.08,"temp_max":290.08,"pressure":1023,"sea_level":1023,"grnd_level":1020,"humidity":72,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":70},"wind":{"speed":0.27,"deg":344,"gust":0.69},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2021-06-08 21:00:00"},{"dt":1623196800,"main":{"temp":288.23,"feels_like":287.91,"temp_min":288.23,"temp_max":288.23,"pressure":1023,"sea_level":1023,"grnd_level":1020,"humidity":81,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":75},"wind":{"speed":0.93,"deg":216,"gust":1.04},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2021-06-09 00:00:00"},{"dt":1623207600,"main":{"temp":286.61,"feels_like":286.28,"temp_min":286.61,"temp_max":286.61,"pressure":1023,"sea_level":1023,"grnd_level":1019,"humidity":87,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":57},"wind":{"speed":1.68,"deg":221,"gust":2.81},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2021-06-09 03:00:00"},{"dt":1623218400,"main":{"temp":287.96,"feels_like":287.27,"temp_min":287.96,"temp_max":287.96,"pressure":1023,"sea_level":1023,"grnd_level":1020,"humidity":68,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":42},"wind":{"speed":2.18,"deg":238,"gust":3.46},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-09 06:00:00"},{"dt":1623229200,"main":{"temp":292.59,"feels_like":291.63,"temp_min":292.59,"temp_max":292.59,"pressure":1023,"sea_level":1023,"grnd_level":1020,"humidity":40,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02d"}],"clouds":{"all":24},"wind":{"speed":2.7,"deg":238,"gust":3.77},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-09 09:00:00"},{"dt":1623240000,"main":{"temp":296.11,"feels_like":295.27,"temp_min":296.11,"temp_max":296.11,"pressure":1022,"sea_level":1022,"grnd_level":1019,"humidity":31,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02d"}],"clouds":{"all":20},"wind":{"speed":3.3,"deg":239,"gust":3.94},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-09 12:00:00"},{"dt":1623250800,"main":{"temp":296.97,"feels_like":296.5,"temp_min":296.97,"temp_max":296.97,"pressure":1021,"sea_level":1021,"grnd_level":1018,"humidity":42,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":8},"wind":{"speed":3.73,"deg":264,"gust":4.19},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-09 15:00:00"},{"dt":1623261600,"main":{"temp":295.63,"feels_like":295.37,"temp_min":295.63,"temp_max":295.63,"pressure":1021,"sea_level":1021,"grnd_level":1018,"humidity":55,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02d"}],"clouds":{"all":19},"wind":{"speed":3.4,"deg":273,"gust":3.67},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-09 18:00:00"},{"dt":1623272400,"main":{"temp":291.58,"feels_like":291.46,"temp_min":291.58,"temp_max":291.58,"pressure":1022,"sea_level":1022,"grnd_level":1019,"humidity":76,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02n"}],"clouds":{"all":16},"wind":{"speed":2.15,"deg":235,"gust":5.67},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2021-06-09 21:00:00"},{"dt":1623283200,"main":{"temp":289.62,"feels_like":289.59,"temp_min":289.62,"temp_max":289.62,"pressure":1022,"sea_level":1022,"grnd_level":1019,"humidity":87,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":9},"wind":{"speed":1.94,"deg":227,"gust":4.42},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2021-06-10 00:00:00"},{"dt":1623294000,"main":{"temp":288.12,"feels_like":288.05,"temp_min":288.12,"temp_max":288.12,"pressure":1022,"sea_level":1022,"grnd_level":1019,"humidity":91,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":8},"wind":{"speed":1.64,"deg":230,"gust":3.81},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2021-06-10 03:00:00"},{"dt":1623304800,"main":{"temp":289.56,"feels_like":289.42,"temp_min":289.56,"temp_max":289.56,"pressure":1022,"sea_level":1022,"grnd_level":1019,"humidity":83,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02d"}],"clouds":{"all":13},"wind":{"speed":2.07,"deg":240,"gust":3.24},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-10 06:00:00"},{"dt":1623315600,"main":{"temp":294.23,"feels_like":294.01,"temp_min":294.23,"temp_max":294.23,"pressure":1022,"sea_level":1022,"grnd_level":1019,"humidity":62,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02d"}],"clouds":{"all":23},"wind":{"speed":2.6,"deg":244,"gust":3.7},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-10 09:00:00"},{"dt":1623326400,"main":{"temp":297.61,"feels_like":297.42,"temp_min":297.61,"temp_max":297.61,"pressure":1021,"sea_level":1021,"grnd_level":1018,"humidity":50,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":29},"wind":{"speed":3.95,"deg":242,"gust":5.13},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-10 12:00:00"},{"dt":1623337200,"main":{"temp":296.34,"feels_like":296.18,"temp_min":296.34,"temp_max":296.34,"pressure":1020,"sea_level":1020,"grnd_level":1017,"humidity":56,"temp_kf":0},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04d"}],"clouds":{"all":93},"wind":{"speed":3.59,"deg":247,"gust":4.89},"visibility":10000,"pop":0.02,"sys":{"pod":"d"},"dt_txt":"2021-06-10 15:00:00"},{"dt":1623348000,"main":{"temp":295.98,"feels_like":295.83,"temp_min":295.98,"temp_max":295.98,"pressure":1020,"sea_level":1020,"grnd_level":1017,"humidity":58,"temp_kf":0},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04d"}],"clouds":{"all":85},"wind":{"speed":3.89,"deg":250,"gust":4.52},"visibility":10000,"pop":0.2,"sys":{"pod":"d"},"dt_txt":"2021-06-10 18:00:00"},{"dt":1623358800,"main":{"temp":292.04,"feels_like":292.07,"temp_min":292.04,"temp_max":292.04,"pressure":1021,"sea_level":1021,"grnd_level":1018,"humidity":80,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02n"}],"clouds":{"all":22},"wind":{"speed":2.13,"deg":245,"gust":5.38},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2021-06-10 21:00:00"},{"dt":1623369600,"main":{"temp":290.16,"feels_like":290.27,"temp_min":290.16,"temp_max":290.16,"pressure":1021,"sea_level":1021,"grnd_level":1018,"humidity":90,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02n"}],"clouds":{"all":11},"wind":{"speed":2.16,"deg":253,"gust":5.49},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2021-06-11 00:00:00"},{"dt":1623380400,"main":{"temp":288.65,"feels_like":288.68,"temp_min":288.65,"temp_max":288.65,"pressure":1021,"sea_level":1021,"grnd_level":1018,"humidity":93,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":1.76,"deg":248,"gust":4.68},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2021-06-11 03:00:00"},{"dt":1623391200,"main":{"temp":290.3,"feels_like":290.19,"temp_min":290.3,"temp_max":290.3,"pressure":1021,"sea_level":1021,"grnd_level":1018,"humidity":81,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":1.99,"deg":243,"gust":3.31},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-11 06:00:00"},{"dt":1623402000,"main":{"temp":295.24,"feels_like":295.05,"temp_min":295.24,"temp_max":295.24,"pressure":1021,"sea_level":1021,"grnd_level":1018,"humidity":59,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":2.5,"deg":258,"gust":3.12},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-11 09:00:00"},{"dt":1623412800,"main":{"temp":298.94,"feels_like":298.75,"temp_min":298.94,"temp_max":298.94,"pressure":1021,"sea_level":1021,"grnd_level":1018,"humidity":45,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":1},"wind":{"speed":2.81,"deg":276,"gust":3.17},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-11 12:00:00"},{"dt":1623423600,"main":{"temp":298.7,"feels_like":298.51,"temp_min":298.7,"temp_max":298.7,"pressure":1020,"sea_level":1020,"grnd_level":1017,"humidity":46,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":74},"wind":{"speed":2.48,"deg":286,"gust":2.76},"visibility":10000,"pop":0.46,"sys":{"pod":"d"},"dt_txt":"2021-06-11 15:00:00"},{"dt":1623434400,"main":{"temp":297.35,"feels_like":297.26,"temp_min":297.35,"temp_max":297.35,"pressure":1020,"sea_level":1020,"grnd_level":1017,"humidity":55,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":76},"wind":{"speed":2.69,"deg":304,"gust":3.24},"visibility":10000,"pop":0.56,"sys":{"pod":"d"},"dt_txt":"2021-06-11 18:00:00"},{"dt":1623445200,"main":{"temp":293.31,"feels_like":293.44,"temp_min":293.31,"temp_max":293.31,"pressure":1022,"sea_level":1022,"grnd_level":1019,"humidity":79,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":2.14,"deg":294,"gust":5.58},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2021-06-11 21:00:00"},{"dt":1623456000,"main":{"temp":291.19,"feels_like":291.35,"temp_min":291.19,"temp_max":291.19,"pressure":1022,"sea_level":1022,"grnd_level":1019,"humidity":88,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":3},"wind":{"speed":1.7,"deg":285,"gust":3.62},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-12 00:00:00"},{"dt":1623466800,"main":{"temp":289.74,"feels_like":289.83,"temp_min":289.74,"temp_max":289.74,"pressure":1023,"sea_level":1023,"grnd_level":1020,"humidity":91,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":7},"wind":{"speed":1.31,"deg":305,"gust":1.53},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-12 03:00:00"},{"dt":1623477600,"main":{"temp":291.5,"feels_like":291.43,"temp_min":291.5,"temp_max":291.5,"pressure":1024,"sea_level":1024,"grnd_level":1020,"humidity":78,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":7},"wind":{"speed":1.07,"deg":320,"gust":1.43},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-12 06:00:00"},{"dt":1623488400,"main":{"temp":296.34,"feels_like":296.2,"temp_min":296.34,"temp_max":296.34,"pressure":1024,"sea_level":1024,"grnd_level":1021,"humidity":57,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":10},"wind":{"speed":1.51,"deg":315,"gust":1.72},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-12 09:00:00"},{"dt":1623499200,"main":{"temp":300.11,"feels_like":300.08,"temp_min":300.11,"temp_max":300.11,"pressure":1024,"sea_level":1024,"grnd_level":1021,"humidity":42,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":7},"wind":{"speed":1.83,"deg":317,"gust":1.6},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-12 12:00:00"},{"dt":1623510000,"main":{"temp":301.24,"feels_like":300.82,"temp_min":301.24,"temp_max":301.24,"pressure":1023,"sea_level":1023,"grnd_level":1020,"humidity":39,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02d"}],"clouds":{"all":14},"wind":{"speed":2.28,"deg":344,"gust":2.53},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-12 15:00:00"},{"dt":1623520800,"main":{"temp":296.89,"feels_like":296.91,"temp_min":296.89,"temp_max":296.89,"pressure":1024,"sea_level":1024,"grnd_level":1021,"humidity":61,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":49},"wind":{"speed":2.75,"deg":79,"gust":3.62},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2021-06-12 18:00:00"},{"dt":1623531600,"main":{"temp":293.07,"feels_like":293.08,"temp_min":293.07,"temp_max":293.07,"pressure":1025,"sea_level":1025,"grnd_level":1022,"humidity":75,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":54},"wind":{"speed":2.72,"deg":92,"gust":5.14},"visibility":10000,"pop":0.04,"sys":{"pod":"d"},"dt_txt":"2021-06-12 21:00:00"}],"city":{"id":2643743,"name":"London","coord":{"lat":51.5085,"lon":-0.1257},"country":"GB","population":1000000,"timezone":3600,"sunrise":1623037511,"sunset":1623096831}}`
	if rr.Body.String() != expected {
		t.Errorf("handler returned unexpected body: got %v want %v",
			rr.Body.String(), expected)
	}
}
